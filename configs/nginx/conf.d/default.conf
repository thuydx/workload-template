server {
  listen  ${BACKEND_PORT};
#   listen [::]:9000 ipv6only=on default_server;
  server_name ${BACKEND_HOST};

  # ------------------------------------------------------------
  # üì¶ Performance & security tuning
  # ------------------------------------------------------------
  client_body_buffer_size     32k;
  client_header_buffer_size   8k;
  large_client_header_buffers 8 64k;
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 2048;
  server_tokens off;

  # ------------------------------------------------------------
  # üß≠ Document root
  # ------------------------------------------------------------
  set $docroot "html";
  if (-d "/var/www/html/public") {
    set $docroot "html/public";
  }

  root "/var/www/${docroot}";
  index index.php index.html index.htm;

  if (!-e $request_filename) {
    rewrite ^.*$ /index.php last;
  }

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  # ------------------------------------------------------------
  # üß© Static assets caching
  # ------------------------------------------------------------
  location ~* \.(jpg|jpeg|gif|png|css|js|ico|svg|woff2?|ttf)$ {
    try_files $uri $uri/ =404;
    access_log off;
    expires 30d;
    add_header Cache-Control "public";
  }

  # Laravel front controller
  location / {
    try_files $uri $uri/ /index.php?$query_string;
  }

  # ------------------------------------------------------------
  # ‚öôÔ∏è PHP-FPM
  # ------------------------------------------------------------
  location ~ \.php$ {
    # ‚úÖ Dynamically use backend-api container & port from env
    fastcgi_pass backend-api:${BACKEND_PORT};
    fastcgi_index index.php;
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    include fastcgi_params;

    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
    # Let Laravel detect HTTPS when behind reverse proxy
    fastcgi_param HTTPS $http_x_forwarded_proto; # optional: let Laravel know
  }

  # Deny .env, .git, etc
  location ~ /\.(env|git|ht) {
      deny all;
  }
}